@model IEnumerable<articlesModel>
@{
    ViewBag.Title = "Trang chủ";
    var streamUrl = (string)(ViewBag.streanUrl ?? "");
    var user = (string)ViewBag.User;
    var userPassowrd = (string)ViewBag.UserPassword;

}

<section class="live-stream-section">
    <div class="container">
        <h1 class="live-title">Vần xổ gà trực tiếp 18h ngày <span id="today"></span> </h1>

        @*<div class="stream-controls">
                <button class="stream-btn active">HD1</button>
                <button class="stream-btn">HD2</button>
                <button class="stream-btn">HD3</button>
                <button class="stream-btn">HD4</button>
            </div>*@

        <div class="stream-container">
            <div class="stream-left">
                <div class="video-player">
                        <div class="viewer-count"><i class="fas fa-eye"></i> <span id="viewerCount"></spanid="viewerCount"></div>
                    <div class="video-container">
                        <div class="live-badge">LIVE</div>
                     
                        <video style="height: 750px !important; width: 100%; object-fit: contain; background: black; "
                               id="player"
                               controls
                               autoplay
                               muted
                               playsinline
                               webkit-playsinline="true"
                               x5-playsinline="true"
                               x5-video-player-type="h5"
                               x5-video-player-fullscreen="false"
                               preload="metadata">
                        </video>
                        <div class="video-info">
                            <h3 style="color:red">CLB GÀ CHỌI LIVE Vần xổ gà 18H30 HÀNG NGÀY</h3>
                            <p class="phone-number"><a href="tel:+84335501179" class="tel-link">033.550.1179</a></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="stream-right">
                <div class="live-chat chat-container">
                    <div class="chat-input" >
                        <input type="text" id="username" class="chat-name" placeholder="Tên của bạn..." required>
                        <input type="text" id="message" class="chat-message" placeholder="Nhập nội dung chat..." required>
                        <button onclick="sendMessage()"><i class="fas fa-paper-plane"></i> Gửi</button>
                    </div>
                    <div class="chat-header" style="margin-top:20px">
                        <h3>Live Chat</h3>
                    </div>
                    <div class="chat-messages">

                    </div>

                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contact Section -->
<section class="contact-section">
    <div class="container">
        <div class="contact-info">
            <h2>Kết Nối Đam Mê</h2>
            <div class="contact-details">
                <p><i class="fas fa-phone"></i> <a href="tel:+84335501179" class="tel-link">033.550.1179</a></p>
                <p style=" width: 90%; "><i class="fas fa-map-marker-alt"></i> Thôn Phú Quý, Xã An Chấn, Huyện Tuy An, Tỉnh Phú Yên</p>
            </div>
            <div class="social-buttons">
                <button class="social-btn zalo">
                    <i class="fab fa-whatsapp"></i>
                    AE KẾT BẠN ZALO
                </button>
                <button class="social-btn vip">
                    <i class="fas fa-crown"></i>
                    NHÓM VIP ZALO
                </button>
                <button class="social-btn facebook">
                    <i class="fab fa-facebook"></i>
                    AE KẾT BẠN FACEBOOK
                </button>
            </div>
        </div>

        <div class="info-panels">
            <div class="panel bank-info">
                <div class="atm-card">
                    <div class="card-header">
                        <div class="bank-logo">
                            <img src="~/thumbnail-logo-vietcombank.jpg" alt="Vietcombank Logo" class="bank-logo-img">
                            <span>VIETCOMBANK</span>
                        </div>
                        <div class="card-type">
                            <i class="fas fa-credit-card"></i>
                            <span>DEBIT</span>
                        </div>
                    </div>

                    <div class="card-number">
                        <span class="number-group">0721</span>
                        <span class="number-group">0006</span>
                        <span class="number-group">3972</span>
                        <span class="number-group">7</span>
                    </div>

                    <div class="card-details">
                        <div class="card-holder">
                            <span class="label">Tên chủ thẻ</span>
                            <span class="value">NGUYEN QUOC TINH</span>
                        </div>
                        <div class="card-expiry">
                            <span class="label">Ngày phát hành</span>
                            <span class="value">01/25</span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div class="chip"></div>
                        <button class="copy-btn">
                            <i class="fas fa-copy"></i>
                            Sao chép STK
                        </button>
                    </div>
                </div>
            </div>

            <div class="panel regulations">
                <h3>Quy định</h3>
                <ul class="rules-list">
                    <li>Vần xổ gà Mua Bán Trên Tinh Thần Giao Lưu Vui Vẻ, Lịch Sự Tránh Lừa Đảo</li>
                    <li>Không Có Số Điện Thoại, Không Cá Cược Dưới Mọi Hình Thức</li>
                    <li>Website hoạt động vì mục đích giải trí</li>
                    <li>Tuân thủ pháp luật Việt Nam</li>
                </ul>
                <button class="chat-btn">Chat Ngay</button>
            </div>
        </div>
    </div>
</section>

<!-- Video Replay Section -->
<section class="replay-section">
    <div class="container">
        <h2>VIDEO XEM LẠI</h2>
        <p class="replay-desc">Video Vần xổ gà được cập nhật hàng ngày</p>
        <div class="video-grid">

            @foreach (var i in Model)
            {
                <div class="video-card" style="cursor:pointer;" onclick="window.location='@Url.Action("Details", "Articles", new { id = i.Id })'">
                    <div class="video-thumbnail" style="background-image: url('\gachoi.jpg'); background-size: cover; background-position: center;">
                        <div class="play-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                    <div class="video-info">
                        <h4>@i.Name</h4>
                        <p class="video-date">@i.CreatedDate</p>
                    </div>
                </div>
            }


        </div>

    </div>
</section>

<!-- About Section -->
<section class="about-section">
    <div class="container">
        <div class="about-header">
            <h2>CLB GÀ CHỌI</h2>
        </div>

        <div class="about-content">
            <div class="about-text">
                <p>Chào mừng bạn đến với CLB GÀ CHỌI C3 - nơi kết nối những người đam mê gà chọi. Chúng tôi cung cấp thông tin về cách nuôi, chăm sóc và huấn luyện gà chọi một cách chuyên nghiệp.</p>
                <p>CLB Gà Chọi hoạt động với mục đích giải trí và giao lưu, không khuyến khích các hoạt động cá cược. Chúng tôi cam kết tuân thủ pháp luật Việt Nam và tạo môi trường lành mạnh cho cộng đồng yêu thích gà chọi.</p>
            </div>

            <div class="about-images">
                <div class="image-collage">
                    <div class="small-image"></div>
                    <div class="small-image"></div>
                    <div class="small-image"></div>
                    <div class="small-image"></div>
                </div>
                <div class="main-image">
                    <h3>CLB Gà Chọi C3 LIVE Vần xổ gà 18H30 HÀNG NGÀY</h3>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
async function playStream() {
        const video = document.getElementById('player');

        // Ngăn video bật fullscreen
        video.addEventListener('webkitbeginfullscreen', function(e) {
            e.preventDefault();
        });

        video.addEventListener('webkitendfullscreen', function(e) {
            e.preventDefault();
        });

        // Đảm bảo playsinline được set
        video.setAttribute('playsinline', true);
        video.setAttribute('webkit-playsinline', true);

        const pc = new RTCPeerConnection();
        pc.ontrack = (event) => {
            video.srcObject = event.streams[0];

            // Đảm bảo video play inline sau khi có stream
            setTimeout(() => {
                video.play().catch(console.error);
            }, 100);
        };

        // Thêm track audio/video vào peer connection
        pc.addTransceiver("video", { direction: "recvonly" });
        pc.addTransceiver("audio", { direction: "recvonly" });

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        const auth = btoa(`@user:@userPassowrd`);

        // Gửi offer đến MediaMTX
        const res = await fetch('@streamUrl' + "/whep", {
            method: "POST",
            body: offer.sdp,
            headers: {
                "Content-Type": "application/sdp",
                'Authorization': `Basic ${auth}`
            },
        });

        const answer = await res.text();
        await pc.setRemoteDescription({
            type: "answer",
            sdp: answer,
        });
    }

    // Khởi chạy sau khi DOM load
    document.addEventListener('DOMContentLoaded', function() {
        playStream();
    });
</script>