
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <title>Live Stream Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
</head>
<body>
    <h1>Live Stream</h1>
    <video id="liveVideo" autoplay style="width: 100%; max-width: 800px;"></video>
    <h2>Previous Streams</h2>
    <ul id="videoList"></ul>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/streamHub")
            .build();

        let mediaSource = new MediaSource();
        let sourceBuffer;

        document.getElementById("liveVideo").src = URL.createObjectURL(mediaSource);
        mediaSource.addEventListener("sourceopen", () => {
            console.log("MediaSource opened");
            sourceBuffer = mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E, mp4a.40.2"');
        });

        connection.on("ReceiveFrame", (frame) => {
            console.log("Received frame:", frame.length);
            if (sourceBuffer && !sourceBuffer.updating && mediaSource.readyState === "open") {
                sourceBuffer.appendBuffer(new Uint8Array(frame));
            }
        });

        connection.on("StreamStarted", () => {
            console.log("ádasd")
            document.getElementById("liveVideo").style.display = "block";
        });

        connection.on("StreamStopped", (videoPath) => {
            console.log("ádasd11111")

            document.getElementById("liveVideo").style.display = "none";
            loadVideoList();
        });

        async function loadVideoList() {
            const response = await fetch("/Stream/GetVideos");
            const videos = await response.json();
            const videoList = document.getElementById("videoList");
            videoList.innerHTML = "";
            videos.forEach(video => {
                const li = document.createElement("li");
                li.innerHTML = `<a href="${video}" target="_blank">Watch ${video}</a>`;
                videoList.appendChild(li);
            });
        }

        connection.start().then(() => loadVideoList()).catch(err => console.error(err));
    </script>
</body>
</html>
